name: Build Metabase

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  JAVA_TOOL_OPTIONS: "-Xmx4g"
  MB_EDITION: "oss"
  CYPRESS_INSTALL_BINARY: "0"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check Repository Structure
        run: |
          echo "üìÇ Ki·ªÉm tra c·∫•u tr√∫c repository..."
          ls -la
          
          echo "üîç T√¨m file build scripts..."
          find . -name "deps.edn" -o -name "build.clj" | head -10
          
          echo "üì¶ Ki·ªÉm tra th∆∞ m·ª•c frontend..."
          ls -la frontend/ 2>/dev/null || echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c frontend"
          
          echo "‚òï Ki·ªÉm tra bin/build..."
          ls -la bin/build/ 2>/dev/null || echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y bin/build"
          
      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn
          
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          
      - name: Install Clojure
        uses: DeLaGuardo/setup-clojure@12.1
        with:
          cli: latest
          
      - name: Cache Clojure Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure
          key: clojure-${{ hashFiles('deps.edn', 'build.clj') }}
          restore-keys: clojure-
          
      - name: Install Frontend Dependencies
        run: |
          echo "üì¶ C√†i ƒë·∫∑t th∆∞ vi·ªán frontend..."
          
          if [ -d "frontend" ]; then
            cd frontend
            
            # B·ªè qua Cypress v√† c√°c dev dependencies kh√¥ng c·∫ßn thi·∫øt
            echo "‚úÖ Install dependencies (b·ªè qua Cypress)..."
            CYPRESS_INSTALL_BINARY=0 yarn install --frozen-lockfile --ignore-optional
            
            cd ..
          else
            CYPRESS_INSTALL_BINARY=0 yarn install --frozen-lockfile --ignore-optional
          fi
          
      - name: Fix Crypto Issue
        run: |
          echo "üîß Fix l·ªói crypto cho password-generator..."
          
          if [ -d "frontend/node_modules" ]; then
            NODE_MODULES_PATH="frontend/node_modules"
          elif [ -d "node_modules" ]; then
            NODE_MODULES_PATH="node_modules"
          else
            echo "‚ùå Kh√¥ng t√¨m th·∫•y node_modules"
            exit 1
          fi
          
          PW_GEN_FILE="$NODE_MODULES_PATH/password-generator/lib/password-generator.js"
          
          if [ -f "$PW_GEN_FILE" ]; then
            echo "‚úÖ T√¨m th·∫•y password-generator t·∫°i: $PW_GEN_FILE"
            cp "$PW_GEN_FILE" "$PW_GEN_FILE.backup"
            sed -i 's/var bytes = require("crypto")\.randomBytes(buf\.length);/var bytes = new Uint8Array(buf.length); if (typeof window !== "undefined" \&\& window.crypto) { window.crypto.getRandomValues(bytes); } else { for (var i = 0; i < buf.length; i++) bytes[i] = Math.floor(Math.random() * 256); }/g' "$PW_GEN_FILE"
            echo "‚úÖ ƒê√£ patch password-generator"
          else
            echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y password-generator"
          fi
          
      - name: Build Frontend
        run: |
          echo "üé® Build giao di·ªán frontend..."
          
          if [ -d "frontend" ]; then
            cd frontend
          fi
          
          yarn build
          
          echo "‚úÖ Frontend build ho√†n t·∫•t"
          
          echo "üìä Ki·ªÉm tra k·∫øt qu·∫£ build frontend:"
          if [ -d "../resources/frontend_client" ]; then
            ls -lh ../resources/frontend_client/ | head -10
            du -sh ../resources/frontend_client/
          elif [ -d "resources/frontend_client" ]; then
            ls -lh resources/frontend_client/ | head -10
            du -sh resources/frontend_client/
          else
            echo "‚ö†Ô∏è C·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y frontend_client"
            find .. -name "*.js" -path "*/resources/*" 2>/dev/null | head -10
          fi
          
      - name: Check Build Files
        run: |
          echo "üîç Ki·ªÉm tra file build Clojure..."
          
          if [ -f "build.clj" ]; then
            echo "‚úÖ T√¨m th·∫•y build.clj"
            head -30 build.clj
          fi
          
          if [ -f "deps.edn" ]; then
            echo "‚úÖ T√¨m th·∫•y deps.edn"
            cat deps.edn | grep -A 10 ":build" || echo "Kh√¥ng t√¨m th·∫•y :build alias"
          fi
          
      - name: Build Backend Uberjar
        run: |
          echo "‚òï Build backend Metabase v·ªõi Clojure..."
          
          if [ ! -f "deps.edn" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y deps.edn!"
            exit 1
          fi
          
          echo "‚úÖ Th·ª≠ build uberjar..."
          
          if clojure -X:build uberjar; then
            echo "‚úÖ Build v·ªõi -X:build uberjar th√†nh c√¥ng"
          elif clojure -T:build uberjar; then
            echo "‚úÖ Build v·ªõi -T:build uberjar th√†nh c√¥ng"
          elif clojure -M:build uberjar; then
            echo "‚úÖ Build v·ªõi -M:build uberjar th√†nh c√¥ng"
          else
            echo "‚ùå Build th·∫•t b·∫°i!"
            echo "üîç Aliases c√≥ s·∫µn:"
            cat deps.edn | grep "^[[:space:]]*:" | head -20
            exit 1
          fi
          
          echo "‚úÖ Backend build ho√†n t·∫•t"
          
          echo "üîç T√¨m file JAR..."
          find . -name "*.jar" -type f -size +1M
          
      - name: Verify JAR File
        run: |
          echo "üìä Ki·ªÉm tra file JAR..."
          
          JAR_FILE=$(find . -name "metabase*.jar" -type f | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y file JAR!"
            echo "üîç T·∫•t c·∫£ file .jar:"
            find . -name "*.jar" -type f
            exit 1
          fi
          
          echo "‚úÖ T√¨m th·∫•y JAR: $JAR_FILE"
          
          FILE_SIZE=$(stat -c%s "$JAR_FILE" 2>/dev/null || stat -f%z "$JAR_FILE" 2>/dev/null)
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          
          echo "üì¶ K√≠ch th∆∞·ªõc: ${FILE_SIZE_MB}MB"
          ls -lh "$JAR_FILE"
          
          if [ "$FILE_SIZE_MB" -lt 100 ]; then
            echo "üö® C·∫¢NH B√ÅO: JAR ch·ªâ ${FILE_SIZE_MB}MB - qu√° nh·ªè!"
            echo "üìã Metabase b√¨nh th∆∞·ªùng: 300-500MB"
            
            echo ""
            echo "üîç N·ªôi dung JAR:"
            jar tf "$JAR_FILE" | head -50
            
            echo ""
            echo "üîç File frontend trong JAR:"
            jar tf "$JAR_FILE" | grep -E "app.*\.js|frontend" | head -20
            
            echo ""
            echo "‚ùå BUILD L·ªñI: JAR kh√¥ng ƒë·∫ßy ƒë·ªß!"
            exit 1
          else
            echo "‚úÖ K√≠ch th∆∞·ªõc h·ª£p l·ªá: ${FILE_SIZE_MB}MB"
          fi
          
          echo ""
          echo "üìä Th·ªëng k√™ JAR:"
          echo "T·ªïng file: $(jar tf "$JAR_FILE" | wc -l)"
          echo "File .class: $(jar tf "$JAR_FILE" | grep -c '\.class$' || echo 0)"
          echo "File .js: $(jar tf "$JAR_FILE" | grep -c '\.js$' || echo 0)"
          
          echo "JAR_PATH=$JAR_FILE" >> $GITHUB_ENV
          
      - name: Upload Metabase JAR
        uses: actions/upload-artifact@v4
        with:
          name: metabase-v${{ github.run_number }}
          path: ${{ env.JAR_PATH }}
          retention-days: 7
          compression-level: 0
          
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.JAR_PATH }}
          name: Metabase ${{ github.ref_name }}
          body: |
            üéâ Metabase Vietnamese Edition
            
            ## C√°ch s·ª≠ d·ª•ng
            ```bash
            java -jar metabase.jar
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build Summary
        if: success()
        run: |
          echo "‚úÖ BUILD TH√ÄNH C√îNG!"
          echo "üì• T·∫£i JAR t·∫°i: Actions ‚Üí Artifacts"
          echo "üöÄ File: metabase-v${{ github.run_number }}"
