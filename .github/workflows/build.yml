name: Build Metabase custom
on: 
  workflow_dispatch:  # Cháº¡y thá»§ cÃ´ng
  push:
    branches: 
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  JAVA_TOOL_OPTIONS: "-Xmx4g"
  MB_EDITION: "oss"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'yarn'
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'
        
    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@12.1
      with:
        cli: 'latest'
        
    - name: Cache Clojure Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
        key: clojure-${{ hashFiles('deps.edn') }}
        restore-keys: clojure-
        
    - name: Install Frontend Dependencies
      run: |
        echo "ğŸ“¦ CÃ i Ä‘áº·t thÆ° viá»‡n frontend..."
        yarn install --frozen-lockfile
        
    - name: Fix Crypto Issue (Package.json Patch)
      run: |
        echo "ğŸ”§ Kiá»ƒm tra vÃ  fix lá»—i crypto..."
        
        # Backup package.json gá»‘c
        cp package.json package.json.backup
        
        # Kiá»ƒm tra xem Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh browser chÆ°a
        if grep -q '"browser"' package.json; then
          echo "âš ï¸  package.json Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh browser, bá» qua patch"
        else
          echo "âœ… ThÃªm cáº¥u hÃ¬nh browser Ä‘á»ƒ fix crypto"
          # TÃ¬m dÃ²ng "dependencies" Ä‘áº§u tiÃªn vÃ  thÃªm browser config trÆ°á»›c Ä‘Ã³
          sed -i '/"dependencies":/i\  "browser": {\n    "crypto": false\n  },' package.json
        fi
        
        # Hiá»ƒn thá»‹ diff Ä‘á»ƒ kiá»ƒm tra
        echo "ğŸ“‹ Thay Ä‘á»•i trong package.json:"
        diff package.json.backup package.json || true
        
        # Kiá»ƒm tra syntax JSON cÃ³ há»£p lá»‡ khÃ´ng
        echo "ğŸ” Kiá»ƒm tra JSON syntax..."
        node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" && echo "âœ… JSON há»£p lá»‡" || echo "âŒ JSON khÃ´ng há»£p lá»‡"
        
    - name: Build Frontend
      run: |
        echo "ğŸ¨ Build giao diá»‡n frontend..."
        yarn build
        
        echo "âœ… Frontend build hoÃ n táº¥t"
        ls -lh resources/frontend_client/
        
    - name: Make Build Script Executable
      run: chmod +x bin/build.sh
      
    - name: Build Backend (Uberjar)
      run: |
        echo "â˜• Build backend Metabase..."
        ./bin/build.sh
        
        echo "âœ… Backend build hoÃ n táº¥t"
        ls -lh target/uberjar/
        
    - name: Verify JAR File
      run: |
        echo "ğŸ“Š ThÃ´ng tin file JAR:"
        ls -lh target/uberjar/metabase.jar
        
        echo "ğŸ“¦ KÃ­ch thÆ°á»›c file:"
        du -h target/uberjar/metabase.jar
        
        echo "ğŸ” Kiá»ƒm tra JAR cÃ³ há»£p lá»‡:"
        jar tf target/uberjar/metabase.jar | head -20
        
    - name: Upload Metabase JAR
      uses: actions/upload-artifact@v4
      with:
        name: metabase-vietnamese-v${{ github.run_number }}
        path: target/uberjar/metabase.jar
        retention-days: 7
        compression-level: 0  # JAR Ä‘Ã£ nÃ©n rá»“i, khÃ´ng cáº§n nÃ©n láº¡i
        
    - name: Create Release (If Tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: target/uberjar/metabase.jar
        name: Metabase Vietnamese ${{ github.ref_name }}
        body: |
          ğŸ‰ Metabase Vietnamese Edition
          
          ## Thay Ä‘á»•i
          - ÄÃ£ sá»­a lá»—i hiá»ƒn thá»‹ tiáº¿ng Viá»‡t
          - Build tá»« branch: main
          
          ## CÃ¡ch sá»­ dá»¥ng
          ```bash
          java -jar metabase.jar
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Build Success
      if: success()
      run: |
        echo "âœ… BUILD THÃ€NH CÃ”NG!"
        echo "ğŸ“¥ Táº£i file JAR táº¡i: Actions â†’ Artifacts"
        echo "ğŸš€ File: metabase-vietnamese-v${{ github.run_number }}"
        
    - name: Notify Build Failed
      if: failure()
      run: |
        echo "âŒ BUILD THáº¤T Báº I!"
        echo "ğŸ” Kiá»ƒm tra logs Ä‘á»ƒ tÃ¬m lá»—i"
