name: Build Metabase
on: 
  workflow_dispatch:
  push:
    branches: 
      - main

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  JAVA_TOOL_OPTIONS: "-Xmx4g"
  MB_EDITION: "oss"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check Repository Structure
      run: |
        echo "üìÇ Ki·ªÉm tra c·∫•u tr√∫c repository..."
        ls -la
        
        echo "üîç T√¨m file build scripts..."
        find . -name "pom.xml" -o -name "deps.edn" -o -name "build.clj" -o -name "build.sh" | head -20
        
        echo "üì¶ Ki·ªÉm tra th∆∞ m·ª•c frontend..."
        ls -la frontend/ 2>/dev/null || echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c frontend"
        
        echo "‚òï Ki·ªÉm tra file Clojure build..."
        ls -la bin/ 2>/dev/null || echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c bin"
        
    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'yarn'
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@12.1
      with:
        cli: 'latest'
        
    - name: Cache Clojure Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
          ~/.clojure
        key: clojure-${{ hashFiles('deps.edn', 'build.clj') }}
        restore-keys: clojure-
        
    - name: Install Frontend Dependencies
      run: |
        echo "üì¶ C√†i ƒë·∫∑t th∆∞ vi·ªán frontend..."
        
        if [ -d "frontend" ]; then
          cd frontend
          yarn install --frozen-lockfile
          cd ..
        else
          echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c frontend, c√†i ƒë·∫∑t ·ªü root..."
          yarn install --frozen-lockfile
        fi
        
    - name: Fix Crypto Issue
      run: |
        echo "üîß Fix l·ªói crypto cho password-generator..."
        
        # X√°c ƒë·ªãnh ƒë√∫ng ƒë∆∞·ªùng d·∫´n node_modules
        if [ -d "frontend/node_modules" ]; then
          NODE_MODULES_PATH="frontend/node_modules"
        elif [ -d "node_modules" ]; then
          NODE_MODULES_PATH="node_modules"
        else
          echo "‚ùå Kh√¥ng t√¨m th·∫•y node_modules"
          exit 1
        fi
        
        PW_GEN_FILE="$NODE_MODULES_PATH/password-generator/lib/password-generator.js"
        
        if [ -f "$PW_GEN_FILE" ]; then
          echo "‚úÖ T√¨m th·∫•y password-generator t·∫°i: $PW_GEN_FILE"
          
          # Backup file g·ªëc
          cp "$PW_GEN_FILE" "$PW_GEN_FILE.backup"
          
          # Thay th·∫ø require("crypto") b·∫±ng browser-compatible code
          sed -i 's/var bytes = require("crypto")\.randomBytes(buf\.length);/var bytes = new Uint8Array(buf.length); if (typeof window !== "undefined" \&\& window.crypto) { window.crypto.getRandomValues(bytes); } else { for (var i = 0; i < buf.length; i++) bytes[i] = Math.floor(Math.random() * 256); }/g' "$PW_GEN_FILE"
          
          echo "‚úÖ ƒê√£ patch password-generator"
          
          # Ki·ªÉm tra thay ƒë·ªïi
          if diff "$PW_GEN_FILE.backup" "$PW_GEN_FILE" > /dev/null; then
            echo "‚ö†Ô∏è  Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë∆∞·ª£c √°p d·ª•ng"
          else
            echo "üìã Thay ƒë·ªïi ƒë√£ √°p d·ª•ng th√†nh c√¥ng"
          fi
        else
          echo "‚ö†Ô∏è  Kh√¥ng t√¨m th·∫•y password-generator, c√≥ th·ªÉ kh√¥ng c·∫ßn patch"
        fi
        
    - name: Build Frontend
      run: |
        echo "üé® Build giao di·ªán frontend..."
        
        if [ -d "frontend" ]; then
          cd frontend
        fi
        
        yarn build
        
        echo "‚úÖ Frontend build ho√†n t·∫•t"
        
        # Ki·ªÉm tra frontend output
        echo "üìä Ki·ªÉm tra k·∫øt qu·∫£ build frontend:"
        if [ -d "../resources/frontend_client" ]; then
          ls -lh ../resources/frontend_client/
          du -sh ../resources/frontend_client/
        elif [ -d "resources/frontend_client" ]; then
          ls -lh resources/frontend_client/
          du -sh resources/frontend_client/
        else
          echo "‚ö†Ô∏è C·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c frontend_client!"
          echo "T√¨m ki·∫øm frontend output..."
          find .. -name "app.js" -o -name "app-main.js" -o -name "main.bundle.js" 2>/dev/null | head -10
        fi
        
    - name: Make Build Script Executable
      run: |
        echo "üîç Ki·ªÉm tra c·∫•u tr√∫c build..."
        
        # Ki·ªÉm tra file build Clojure
        if [ -f "build.clj" ]; then
          echo "‚úÖ T√¨m th·∫•y build.clj"
          head -20 build.clj
        fi
        
        if [ -f "deps.edn" ]; then
          echo "‚úÖ T√¨m th·∫•y deps.edn"
          cat deps.edn | grep -A 5 ":build"
        fi
        
        # Ki·ªÉm tra th∆∞ m·ª•c bin/build
        if [ -d "bin/build" ]; then
          echo "‚úÖ T√¨m th·∫•y bin/build/"
          ls -la bin/build/
        fi
      
    - name: Build Backend (Uberjar)
      run: |
        echo "‚òï Build backend Metabase v·ªõi Clojure..."
        
        # Ki·ªÉm tra xem c√≥ deps.edn v√† build.clj kh√¥ng
        if [ ! -f "deps.edn" ]; then
          echo "‚ùå Kh√¥ng t√¨m th·∫•y deps.edn!"
          exit 1
        fi
        
        if [ ! -f "build.clj" ]; then
          echo "‚ùå Kh√¥ng t√¨m th·∫•y build.clj!"
          exit 1
        fi
        
        echo "‚úÖ Build uberjar v·ªõi Clojure CLI..."
        
        # Th·ª≠ c√°c l·ªánh build kh√°c nhau
        if clojure -X:build uberjar; then
          echo "‚úÖ Build v·ªõi -X:build uberjar th√†nh c√¥ng"
        elif clojure -T:build uberjar; then
          echo "‚úÖ Build v·ªõi -T:build uberjar th√†nh c√¥ng"  
        elif clojure -M:build uberjar; then
          echo "‚úÖ Build v·ªõi -M:build uberjar th√†nh c√¥ng"
        else
          echo "‚ùå T·∫•t c·∫£ l·ªánh build ƒë·ªÅu th·∫•t b·∫°i!"
          echo "üîç Ki·ªÉm tra aliases c√≥ s·∫µn trong deps.edn:"
          cat deps.edn | grep -E "^\s*:" | head -20
          exit 1
        fi
        
        echo "‚úÖ Backend build ho√†n t·∫•t"
        
        # T√¨m file JAR
        echo "üîç T√¨m file JAR ƒë√£ build..."
        find . -name "*.jar" -type f -size +1M
        
    - name: Verify JAR File
      run: |
        echo "üìä Ki·ªÉm tra file JAR..."
        
        # T√¨m file JAR
        JAR_FILE=$(find . -name "metabase*.jar" -o -name "*.jar" | grep -E "target|build|out" | head -1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "‚ùå Kh√¥ng t√¨m th·∫•y file JAR!"
          echo "üîç T√¨m ki·∫øm trong to√†n b·ªô project:"
          find . -name "*.jar" -type f
          exit 1
        fi
        
        echo "‚úÖ T√¨m th·∫•y JAR: $JAR_FILE"
        
        # Ki·ªÉm tra k√≠ch th∆∞·ªõc
        FILE_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null)
        FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
        
        echo "üì¶ K√≠ch th∆∞·ªõc file: ${FILE_SIZE_MB}MB"
        ls -lh "$JAR_FILE"
        
        # C·∫¢NH B√ÅO n·∫øu file qu√° nh·ªè
        if [ "$FILE_SIZE_MB" -lt 100 ]; then
          echo "üö® C·∫¢NH B√ÅO: File JAR ch·ªâ ${FILE_SIZE_MB}MB - qu√° nh·ªè!"
          echo "üìã File Metabase b√¨nh th∆∞·ªùng ph·∫£i 300-500MB"
          echo "‚ùå C√ì TH·ªÇ THI·∫æU FRONTEND HO·∫∂C DEPENDENCIES"
          
          echo ""
          echo "üîç Ki·ªÉm tra n·ªôi dung JAR:"
          jar tf "$JAR_FILE" | head -50
          
          echo ""
          echo "üîç T√¨m frontend trong JAR:"
          jar tf "$JAR_FILE" | grep -E "app.*\.js|frontend" | head -20
          
          echo ""
          echo "üîç Ki·ªÉm tra th∆∞ m·ª•c resources:"
          find resources -type f 2>/dev/null | head -20
          
          echo ""
          echo "‚ùå BUILD L·ªñI: JAR qu√° nh·ªè, kh√¥ng th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c!"
          exit 1
        else
          echo "‚úÖ K√≠ch th∆∞·ªõc JAR h·ª£p l·ªá: ${FILE_SIZE_MB}MB"
        fi
        
        echo ""
        echo "üîç Ki·ªÉm tra JAR c√≥ h·ª£p l·ªá:"
        jar tf "$JAR_FILE" | head -20
        
        echo ""
        echo "üìä Th·ªëng k√™ n·ªôi dung JAR:"
        echo "T·ªïng s·ªë file: $(jar tf "$JAR_FILE" | wc -l)"
        echo "File .class: $(jar tf "$JAR_FILE" | grep -c '\.class
        
    - name: Upload Metabase JAR
      uses: actions/upload-artifact@v4
      with:
        name: metabase-vietnamese-v${{ github.run_number }}
        path: ${{ env.JAR_PATH }}
        retention-days: 7
        compression-level: 0
        
    - name: Create Release (If Tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.JAR_PATH }}
        name: Metabase Vietnamese ${{ github.ref_name }}
        body: |
          üéâ Metabase Vietnamese Edition
          
          ## C√°ch s·ª≠ d·ª•ng
          ```bash
          java -jar metabase.jar
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Build Success
      if: success()
      run: |
        echo "‚úÖ BUILD TH√ÄNH C√îNG!"
        echo "üì• T·∫£i file JAR t·∫°i: Actions ‚Üí Artifacts"
        echo "üöÄ File: metabase-vietnamese-v${{ github.run_number }}"
        
    - name: Notify Build Failed
      if: failure()
      run: |
        echo "‚ùå BUILD TH·∫§T B·∫†I!"
        echo "üîç Ki·ªÉm tra logs ƒë·ªÉ t√¨m l·ªói"
        
     echo "File .js: $(jar tf "$JAR_FILE" | grep -c '\.js
        
    - name: Upload Metabase JAR
      uses: actions/upload-artifact@v4
      with:
        name: metabase-vietnamese-v${{ github.run_number }}
        path: ${{ env.JAR_PATH }}
        retention-days: 7
        compression-level: 0
        
    - name: Create Release (If Tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.JAR_PATH }}
        name: Metabase Vietnamese ${{ github.ref_name }}
        body: |
          üéâ Metabase Vietnamese Edition
          
          ## C√°ch s·ª≠ d·ª•ng
          ```bash
          java -jar metabase.jar
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Build Success
      if: success()
      run: |
        echo "‚úÖ BUILD TH√ÄNH C√îNG!"
        echo "üì• T·∫£i file JAR t·∫°i: Actions ‚Üí Artifacts"
        echo "üöÄ File: metabase-vietnamese-v${{ github.run_number }}"
        
    - name: Notify Build Failed
      if: failure()
      run: |
        echo "‚ùå BUILD TH·∫§T B·∫†I!"
        echo "üîç Ki·ªÉm tra logs ƒë·ªÉ t√¨m l·ªói"
        
        # L∆∞u ƒë∆∞·ªùng d·∫´n JAR
        echo "JAR_PATH=$JAR_FILE" >> $GITHUB_ENV
        
    - name: Upload Metabase JAR
      uses: actions/upload-artifact@v4
      with:
        name: metabase-vietnamese-v${{ github.run_number }}
        path: ${{ env.JAR_PATH }}
        retention-days: 7
        compression-level: 0
        
    - name: Create Release (If Tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.JAR_PATH }}
        name: Metabase Vietnamese ${{ github.ref_name }}
        body: |
          üéâ Metabase Vietnamese Edition
          
          ## C√°ch s·ª≠ d·ª•ng
          ```bash
          java -jar metabase.jar
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Build Success
      if: success()
      run: |
        echo "‚úÖ BUILD TH√ÄNH C√îNG!"
        echo "üì• T·∫£i file JAR t·∫°i: Actions ‚Üí Artifacts"
        echo "üöÄ File: metabase-vietnamese-v${{ github.run_number }}"
        
    - name: Notify Build Failed
      if: failure()
      run: |
        echo "‚ùå BUILD TH·∫§T B·∫†I!"
        echo "üîç Ki·ªÉm tra logs ƒë·ªÉ t√¨m l·ªói"
