name: Build Metabase (Stable Fix)
on: workflow_dispatch

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  JAVA_TOOL_OPTIONS: "-Xmx4g"
  MB_EDITION: "oss"
  # Ch·∫∑n Cypress t·∫£i v·ªÅ ƒë·ªÉ ti·∫øt ki·ªám th·ªùi gian
  CYPRESS_INSTALL_BINARY: "0"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn
          
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          
      - name: Install Clojure
        uses: DeLaGuardo/setup-clojure@12.1
        with:
          cli: latest
          
      - name: Install Frontend Dependencies
        run: |
          echo "üì¶ C√†i ƒë·∫∑t th∆∞ vi·ªán frontend..."
          # QUAN TR·ªåNG: Kh√¥ng d√πng --ignore-optional ƒë·ªÉ Rspack t·∫£i ƒë·ªß binary
          if [ -d "frontend" ]; then
            cd frontend
            yarn install --frozen-lockfile
            cd ..
          else
            yarn install --frozen-lockfile
          fi
          
      - name: Patch Crypto & Build Frontend
        run: |
          echo "üîß B·∫Øt ƒë·∫ßu quy tr√¨nh v√° l·ªói Crypto..."
          
          # X√°c ƒë·ªãnh v·ªã tr√≠ file c·∫ßn s·ª≠a
          if [ -f "frontend/node_modules/password-generator/lib/password-generator.js" ]; then
             TARGET_FILE="frontend/node_modules/password-generator/lib/password-generator.js"
             cd frontend
          elif [ -f "node_modules/password-generator/lib/password-generator.js" ]; then
             TARGET_FILE="node_modules/password-generator/lib/password-generator.js"
          else
             echo "‚ùå Kh√¥ng t√¨m th·∫•y file password-generator.js"
             exit 1
          fi
          
          echo "File m·ª•c ti√™u: $TARGET_FILE"
          
          # 1. Runtime Fix: ƒê·ªïi ƒëi·ªÅu ki·ªán if th√†nh false ƒë·ªÉ tr√¨nh duy·ªát b·ªè qua ƒëo·∫°n code l·ªói
          sed -i 's/typeof require !== "undefined"/false/g' node_modules/password-generator/lib/password-generator.js
          
          # 2. Build Fix: X√≥a t·ª´ kh√≥a require ƒë·ªÉ Rspack kh√¥ng b√°o l·ªói thi·∫øu module
          sed -i 's/require("crypto")/null/g' node_modules/password-generator/lib/password-generator.js
          
          echo "‚úÖ ƒê√£ patch xong code."
          
          echo "üé® Build Frontend..."
          yarn build
          
          # Quay ra th∆∞ m·ª•c g·ªëc n·∫øu n√£y ƒë√£ cd v√†o
          if [ -d "frontend" ]; then cd ..; fi

      - name: Build Backend (Official Script)
        run: |
          echo "‚òï Build Backend..."
          
          # T√¨m ƒë√∫ng file script ch·∫°y build
          if [ -f "bin/build.sh" ]; then
             echo "‚úÖ T√¨m th·∫•y bin/build.sh"
             chmod +x bin/build.sh
             ./bin/build.sh
          elif [ -f "bin/build" ]; then
             echo "‚úÖ T√¨m th·∫•y bin/build"
             chmod +x bin/build
             ./bin/build
          else
             echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y script build chu·∫©n, th·ª≠ d√πng Clojure tr·ª±c ti·∫øp..."
             # Fallback n·∫øu kh√¥ng c√≥ script
             clojure -T:build uberjar
          fi

      - name: Verify & Upload
        uses: actions/upload-artifact@v4
        with:
          name: metabase-stable-build
          path: target/uberjar/metabase.jar
          retention-days: 1
