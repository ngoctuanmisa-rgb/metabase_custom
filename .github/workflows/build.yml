name: Build Metabase
on: 
  workflow_dispatch:  # Cháº¡y thá»§ cÃ´ng
  push:
    branches: 
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  JAVA_TOOL_OPTIONS: "-Xmx4g"
  MB_EDITION: "oss"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check Repository Structure
      run: |
        echo "ğŸ“‚ Kiá»ƒm tra cáº¥u trÃºc repository..."
        ls -la
        
        echo "ğŸ” TÃ¬m file build scripts..."
        find . -name "pom.xml" -o -name "deps.edn" -o -name "build.clj" -o -name "build.sh" | head -20
        
        echo "ğŸ“¦ Kiá»ƒm tra thÆ° má»¥c frontend..."
        ls -la frontend/ 2>/dev/null || echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c frontend"
        
        echo "â˜• Kiá»ƒm tra file Clojure build..."
        ls -la bin/ 2>/dev/null || echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c bin"
        
    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'yarn'
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'
        
    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@12.1
      with:
        cli: 'latest'
        
    - name: Cache Clojure Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
          ~/.clojure
        key: clojure-${{ hashFiles('deps.edn', 'build.clj') }}
        restore-keys: clojure-
        
    - name: Install Frontend Dependencies
      run: |
        echo "ğŸ“¦ CÃ i Ä‘áº·t thÆ° viá»‡n frontend..."
        
        # Kiá»ƒm tra xem cÃ³ thÆ° má»¥c frontend khÃ´ng
        if [ -d "frontend" ]; then
          cd frontend
          yarn install --frozen-lockfile
        else
          echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c frontend, cÃ i Ä‘áº·t á»Ÿ root..."
          yarn install --frozen-lockfile
        fi
        
    - name: Fix Crypto Issue (Package.json Patch)
      run: |
        echo "ğŸ”§ Kiá»ƒm tra vÃ  fix lá»—i crypto..."
        
        # Backup package.json gá»‘c
        cp package.json package.json.backup
        
        # Kiá»ƒm tra xem Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh browser chÆ°a
        if grep -q '"browser"' package.json; then
          echo "âš ï¸  package.json Ä‘Ã£ cÃ³ cáº¥u hÃ¬nh browser, bá» qua patch"
        else
          echo "âœ… ThÃªm cáº¥u hÃ¬nh browser Ä‘á»ƒ fix crypto"
          # TÃ¬m dÃ²ng "dependencies" Ä‘áº§u tiÃªn vÃ  thÃªm browser config trÆ°á»›c Ä‘Ã³
          sed -i '/"dependencies":/i\  "browser": {\n    "crypto": false\n  },' package.json
        fi
        
        # Hiá»ƒn thá»‹ diff Ä‘á»ƒ kiá»ƒm tra
        echo "ğŸ“‹ Thay Ä‘á»•i trong package.json:"
        diff package.json.backup package.json || true
        
        # Kiá»ƒm tra syntax JSON cÃ³ há»£p lá»‡ khÃ´ng
        echo "ğŸ” Kiá»ƒm tra JSON syntax..."
        node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" && echo "âœ… JSON há»£p lá»‡" || echo "âŒ JSON khÃ´ng há»£p lá»‡"
        
    - name: Build Frontend
      run: |
        echo "ğŸ¨ Build giao diá»‡n frontend..."
        yarn build
        
        echo "âœ… Frontend build hoÃ n táº¥t"
        ls -lh resources/frontend_client/
        
    - name: Make Build Script Executable
      run: chmod +x bin/build.sh
      
    - name: Build Backend (Uberjar)
      run: |
        echo "â˜• Build backend Metabase..."
        
        # Kiá»ƒm tra xem cÃ³ script build.sh khÃ´ng
        if [ -f "bin/build.sh" ]; then
          echo "âœ… Sá»­ dá»¥ng bin/build.sh"
          chmod +x bin/build.sh
          ./bin/build.sh
        elif [ -f "build.sh" ]; then
          echo "âœ… Sá»­ dá»¥ng build.sh á»Ÿ root"
          chmod +x build.sh
          ./build.sh
        elif [ -f "build.clj" ]; then
          echo "âœ… Build báº±ng Clojure build.clj"
          clojure -T:build uberjar
        elif [ -f "deps.edn" ]; then
          echo "âœ… Build báº±ng deps.edn"
          clojure -X:build uberjar
        else
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y script build!"
          echo "ğŸ” CÃ¡c file cÃ³ sáºµn:"
          ls -la
          exit 1
        fi
        
        echo "âœ… Backend build hoÃ n táº¥t"
        
        # TÃ¬m file JAR
        echo "ğŸ” TÃ¬m file JAR Ä‘Ã£ build..."
        find . -name "*.jar" -type f
        
    - name: Verify JAR File
      run: |
        echo "ğŸ“Š ThÃ´ng tin file JAR:"
        
        # TÃ¬m file JAR trong cÃ¡c thÆ° má»¥c cÃ³ thá»ƒ cÃ³
        JAR_FILE=$(find . -name "metabase*.jar" -o -name "*.jar" | grep -E "target|build|out" | head -1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y file JAR!"
          echo "ğŸ” TÃ¬m kiáº¿m trong toÃ n bá»™ project:"
          find . -name "*.jar" -type f
          exit 1
        fi
        
        echo "âœ… TÃ¬m tháº¥y JAR: $JAR_FILE"
        ls -lh "$JAR_FILE"
        
        echo "ğŸ“¦ KÃ­ch thÆ°á»›c file:"
        du -h "$JAR_FILE"
        
        echo "ğŸ” Kiá»ƒm tra JAR cÃ³ há»£p lá»‡:"
        jar tf "$JAR_FILE" | head -20
        
        # LÆ°u Ä‘Æ°á»ng dáº«n JAR Ä‘á»ƒ dÃ¹ng cho step sau
        echo "JAR_PATH=$JAR_FILE" >> $GITHUB_ENV
        
    - name: Upload Metabase JAR
      uses: actions/upload-artifact@v4
      with:
        name: metabase-vietnamese-v${{ github.run_number }}
        path: ${{ env.JAR_PATH }}
        retention-days: 7
        compression-level: 0  # JAR Ä‘Ã£ nÃ©n rá»“i, khÃ´ng cáº§n nÃ©n láº¡i
        
    - name: Create Release (If Tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.JAR_PATH }}
        name: Metabase Vietnamese ${{ github.ref_name }}
        body: |
          ğŸ‰ Metabase Vietnamese Edition
          
          ## Thay Ä‘á»•i
          - ÄÃ£ sá»­a lá»—i hiá»ƒn thá»‹ tiáº¿ng Viá»‡t
          - Build tá»« branch: main
          
          ## CÃ¡ch sá»­ dá»¥ng
          ```bash
          java -jar metabase.jar
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Build Success
      if: success()
      run: |
        echo "âœ… BUILD THÃ€NH CÃ”NG!"
        echo "ğŸ“¥ Táº£i file JAR táº¡i: Actions â†’ Artifacts"
        echo "ğŸš€ File: metabase-vietnamese-v${{ github.run_number }}"
        
    - name: Notify Build Failed
      if: failure()
      run: |
        echo "âŒ BUILD THáº¤T Báº I!"
        echo "ğŸ” Kiá»ƒm tra logs Ä‘á»ƒ tÃ¬m lá»—i"
