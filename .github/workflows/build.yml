name: Build Metabase Custom
on: 
  workflow_dispatch:
  push:
    branches: 
      - main

env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  JAVA_TOOL_OPTIONS: "-Xmx4g"
  MB_EDITION: "oss"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check Repository Structure
      run: |
        echo "ğŸ“‚ Kiá»ƒm tra cáº¥u trÃºc repository..."
        ls -la
        
        echo "ğŸ” TÃ¬m file build scripts..."
        find . -name "pom.xml" -o -name "deps.edn" -o -name "build.clj" -o -name "build.sh" | head -20
        
        echo "ğŸ“¦ Kiá»ƒm tra thÆ° má»¥c frontend..."
        ls -la frontend/ 2>/dev/null || echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c frontend"
        
        echo "â˜• Kiá»ƒm tra file Clojure build..."
        ls -la bin/ 2>/dev/null || echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c bin"
        
    - name: Set up Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'yarn'
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@12.1
      with:
        cli: 'latest'
        
    - name: Cache Clojure Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
          ~/.clojure
        key: clojure-${{ hashFiles('deps.edn', 'build.clj') }}
        restore-keys: clojure-
        
    - name: Install Frontend Dependencies
      run: |
        echo "ğŸ“¦ CÃ i Ä‘áº·t thÆ° viá»‡n frontend..."
        
        if [ -d "frontend" ]; then
          cd frontend
          yarn install --frozen-lockfile
        else
          echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c frontend, cÃ i Ä‘áº·t á»Ÿ root..."
          yarn install --frozen-lockfile
        fi
        
    - name: Fix Crypto Issue
      run: |
        echo "ğŸ”§ Fix lá»—i crypto cho password-generator..."
        
        # Fix trá»±c tiáº¿p trong file password-generator
        PW_GEN_FILE="node_modules/password-generator/lib/password-generator.js"
        
        if [ -f "$PW_GEN_FILE" ]; then
          echo "âœ… TÃ¬m tháº¥y password-generator, Ä‘ang patch..."
          
          # Backup file gá»‘c
          cp "$PW_GEN_FILE" "$PW_GEN_FILE.backup"
          
          # Thay tháº¿ dÃ²ng require("crypto") báº±ng crypto polyfill
          sed -i 's/var bytes = require("crypto")\.randomBytes(buf\.length);/var bytes = (typeof window !== "undefined" \&\& window.crypto) ? window.crypto.getRandomValues(new Uint8Array(buf.length)) : new Uint8Array(buf.length).map(() => Math.floor(Math.random() * 256));/g' "$PW_GEN_FILE"
          
          echo "âœ… ÄÃ£ patch password-generator"
          
          # Hiá»ƒn thá»‹ thay Ä‘á»•i
          echo "ğŸ“‹ Thay Ä‘á»•i:"
          diff "$PW_GEN_FILE.backup" "$PW_GEN_FILE" || true
        else
          echo "âš ï¸  KhÃ´ng tÃ¬m tháº¥y password-generator, bá» qua"
        fi
        
    - name: Build Frontend
      run: |
        echo "ğŸ¨ Build giao diá»‡n frontend..."
        
        if [ -d "frontend" ]; then
          cd frontend
        fi
        
        yarn build
        
        echo "âœ… Frontend build hoÃ n táº¥t"
        
    - name: Make Build Script Executable
      run: |
        if [ -f "bin/build.sh" ]; then
          chmod +x bin/build.sh
        fi
        if [ -f "build.sh" ]; then
          chmod +x build.sh
        fi
      
    - name: Build Backend (Uberjar)
      run: |
        echo "â˜• Build backend Metabase..."
        
        if [ -f "bin/build.sh" ]; then
          echo "âœ… Sá»­ dá»¥ng bin/build.sh"
          ./bin/build.sh
        elif [ -f "build.sh" ]; then
          echo "âœ… Sá»­ dá»¥ng build.sh á»Ÿ root"
          ./build.sh
        elif [ -f "build.clj" ]; then
          echo "âœ… Build báº±ng Clojure build.clj"
          clojure -T:build uberjar
        elif [ -f "deps.edn" ]; then
          echo "âœ… Build báº±ng deps.edn"
          clojure -X:build uberjar
        else
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y script build!"
          echo "ğŸ” CÃ¡c file cÃ³ sáºµn:"
          ls -la
          exit 1
        fi
        
        echo "âœ… Backend build hoÃ n táº¥t"
        
        echo "ğŸ” TÃ¬m file JAR Ä‘Ã£ build..."
        find . -name "*.jar" -type f
        
    - name: Verify JAR File
      run: |
        echo "ğŸ“Š ThÃ´ng tin file JAR:"
        
        # TÃ¬m file JAR trong cÃ¡c thÆ° má»¥c cÃ³ thá»ƒ cÃ³
        JAR_FILE=$(find . -name "metabase*.jar" -o -name "*.jar" | grep -E "target|build|out" | head -1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "âŒ KhÃ´ng tÃ¬m tháº¥y file JAR!"
          echo "ğŸ” TÃ¬m kiáº¿m trong toÃ n bá»™ project:"
          find . -name "*.jar" -type f
          exit 1
        fi
        
        echo "âœ… TÃ¬m tháº¥y JAR: $JAR_FILE"
        ls -lh "$JAR_FILE"
        
        echo "ğŸ“¦ KÃ­ch thÆ°á»›c file:"
        du -h "$JAR_FILE"
        
        echo "ğŸ” Kiá»ƒm tra JAR cÃ³ há»£p lá»‡:"
        jar tf "$JAR_FILE" | head -20
        
        # LÆ°u Ä‘Æ°á»ng dáº«n JAR Ä‘á»ƒ dÃ¹ng cho step sau
        echo "JAR_PATH=$JAR_FILE" >> $GITHUB_ENV
        
    - name: Upload Metabase JAR
      uses: actions/upload-artifact@v4
      with:
        name: metabase-vietnamese-v${{ github.run_number }}
        path: ${{ env.JAR_PATH }}
        retention-days: 7
        compression-level: 0
        
    - name: Create Release (If Tagged)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.JAR_PATH }}
        name: Metabase Vietnamese ${{ github.ref_name }}
        body: |
          ğŸ‰ Metabase Vietnamese Edition
          
          ## CÃ¡ch sá»­ dá»¥ng
          ```bash
          java -jar metabase.jar
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Build Success
      if: success()
      run: |
        echo "âœ… BUILD THÃ€NH CÃ”NG!"
        echo "ğŸ“¥ Táº£i file JAR táº¡i: Actions â†’ Artifacts"
        echo "ğŸš€ File: metabase-vietnamese-v${{ github.run_number }}"
        
    - name: Notify Build Failed
      if: failure()
      run: |
        echo "âŒ BUILD THáº¤T Báº I!"
        echo "ğŸ” Kiá»ƒm tra logs Ä‘á»ƒ tÃ¬m lá»—i"
